---
title: "Data"
format:
  html:
    code-fold: false
---

```{r}
#| label: setup-data-page
#| include: false
#| warning: false

# Set working directory to project root (needed when rendering from subdirectory)
if (basename(getwd()) == "pages") {
  setwd("..")
}

source("V1/Scripts/V1_Dashboard_setup.R")
message("✅ _setup.R successfully loaded!")

```

## Global Dengue Observatory Data

You can download the **latest processed data** and its **metadata** directly from this page.

---

```{r}
#| label: last-update
#| include: false
#| warning: false

latest_dataset_info <- get_latest_dataset_info()
latest_update_label <- latest_dataset_info$label

```

### Download Dataset

```{r}
#| echo: false
#| message: false
#| warning: false
#  --- Select final dataset columns ---
simple_data <- data %>%
  dplyr::select(
    Region, Country,
    source, Data_status,
    Year, Month, season_nMonth,
    cases, cum_todate_cases_calendar,
    Predicted_total_seasonal_cases,
    Ave_season_monthly_cases, Ave_monthly_proportion,
    Ave_season_monthly_cum_cases, Ave_cum_monthly_proportion
  ) %>%
  mutate(
        Predicted_total_seasonal_cases = round(Predicted_total_seasonal_cases, 0),
        Ave_season_monthly_cases = round(Ave_season_monthly_cases, 0), 
        Ave_monthly_proportion = round(Ave_monthly_proportion, 2),
        Ave_season_monthly_cum_cases = round(Ave_season_monthly_cum_cases, 0), 
        Ave_cum_monthly_proportion = round(Ave_cum_monthly_proportion, 2)
  )
  

# --- Save data + metadata for download ---
if (!dir.exists("www")) dir.create("www")

data_file <- "www/global_dengue_data.csv"
meta_file <- "www/global_dengue_metadata.csv"

# Save data file
write.csv(simple_data, data_file, row.names = FALSE)

# --- Create improved metadata ---
metadata <- tibble::tibble(
  Field = c(
    "Region", "Country", "source", "Data_status",
    "Year", "Month", "season_nMonth",
    "cases", "cum_todate_cases_calendar",
    "Predicted_total_seasonal_cases",
    "Ave_season_monthly_cases", "Ave_monthly_proportion",
    "Ave_season_monthly_cum_cases", "Ave_cum_monthly_proportion"
  ),
  Type = c(
    rep("character", 4),
    rep("integer", 3),
    rep("numeric", 7)
  ),
  Description = c(
    "Broad world region where the country is located.",
    "Country name corresponding.",
    "Primary data source (e.g., WHO, PAHO, SEARO, OpenDengue).",
    "Status of the data record: 'Observed', 'Nowcast', or 'Backfilled'.",
    "Calendar year of the observation.",
    "Calendar month (1–12).",
    "Month number within the current dengue season (1 = first month of the season).",
    "Number of dengue cases for that country and month.",
    "Cumulative dengue cases in the current calendar year up to this month.",
    "Predicted total dengue cases for the entire dengue season (model-based).",
    "Average monthly cases across all historical dengue seasons for this country.",
    "Average proportion of cases in this month relative to the full dengue season.",
    "Average cumulative cases across all seasons up to this month.",
    "Average cumulative proportion of seasonal cases reached by this month."
  ),
  Units = c(
    rep("Text", 4),
    rep("Unitless (count/month index)", 3),
    rep("Number of cases / proportion", 7)
  )
)

write.csv(metadata, meta_file, row.names = FALSE)

# --- Create download buttons ---
htmltools::tags$div(
  class = "download-buttons",
  htmltools::tags$a(
    href = data_file,
    download = "global_dengue_data.csv",
    class = "btn btn-success me-2",
    "⬇ Download Data (.csv)"
  ),
  htmltools::tags$a(
    href = meta_file,
    download = "global_dengue_metadata.csv",
    class = "btn btn-outline-primary",
    "ℹ Download Metadata (.csv)"
  ),
  htmltools::tags$span(
    class = "last-updated",
    paste("Last updated:", latest_update_label)
  )
)
```

```{r}
#| echo: false
#| message: false
#| warning: false

DT::datatable(
  simple_data,
  filter = "top",
  options = list(
    pageLength = 10,
    scrollX = TRUE
  ),
  caption = htmltools::tags$caption(
    style = 'caption-side: top; text-align: left;',
    'Table: ', htmltools::em('Global dengue cases by country and month')
  )
)


```

```{r}
#| echo: false
#| 
DT::datatable(metadata, options = list(dom = 't', scrollX = TRUE), rownames = FALSE)

```